---
AWSTemplateFormatVersion: 2010-09-09
Description: This template allow to launch a new environment with ECS Fargate with ALB.
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
    - Label:
        default: AWS Quick Start Configuration
      Parameters:
      - QSS3BucketName
      - QSS3KeyPrefix
    - Label:
        default: 'Principal VPC configuration (Required)'
      Parameters:
      - pVpCIDR
      - pPublicSubnet1CIDR
      - pPublicSubnet2CIDR
      - pPrivateSubnet1CIDR
      - pPrivateSubnet2CIDR
      - pKeyPair
      - pImageURL

    ParameterLabels:
      pVpCIDR:
        default: The ACIDR of the principal VPC
      pPublicSubnet1CIDR:
        default: The ACIDR of the DMZ subnet A
      pPublicSubnet2CIDR:
        default: The ACIDR of the DMZ subnet B
      pPrivateSubnet1CIDR:
        default: The ACIDR of the app A private subnet
      pPrivateSubnet2CIDR:
        default: The ACIDR of the app B private subnet
      pKeyPair:
        default: KeyPair for Cluser
      pImageURL:
        default: URL for docker image
      QSS3BucketName:
        default: Quick Start S3 Bucket Name
      QSS3KeyPrefix:
        default: Quick Start S3 Key Prefix

  Stack:
    Value: 0
  VersionDate:
    Value: 20160518
  Identifier:
    Value: main
  Input:
    Description: Input of all required parameters in nested stacks
  Output:
    Description: N/A
Parameters:
  pVpCIDR:
    Type: String
    Default: 10.2.0.0/16
  pPublicSubnet1CIDR:
    Type: String
    Default: 10.2.1.0/24
  pPublicSubnet2CIDR:
    Type: String
    Default: 10.2.2.0/24
  pPrivateSubnet1CIDR:
    Type: String
    Default: 10.2.3.0/24
  pPrivateSubnet2CIDR:
    Type: String
    Default: 10.2.4.0/25
  pImageURL:
    Type: String
    Default: 202279780353.dkr.ecr.us-east-1.amazonaws.com/circleci:latest
  QSS3BucketName:
    AllowedPattern: ^[0-9a-zA-Z]+([0-9a-zA-Z-.]*[0-9a-zA-Z])*$
    ConstraintDescription: Quick Start bucket name can include numbers, lowercase
      letters, uppercase letters, periods (.), and hyphens (-). It cannot start or
      end with a hyphen (-).
    Default: veniti-infraestructure
    Description: S3 bucket name for the Quick Start assets. Quick Start bucket name
      can include numbers, lowercase letters, uppercase letters, and hyphens (-).
      It cannot start or end with a hyphen (-).
    Type: String
  QSS3KeyPrefix:
    AllowedPattern: ^[0-9a-zA-Z-]+(/[0-9a-zA-Z-]+)*$
    ConstraintDescription: Quick Start key prefix can include numbers, lowercase letters,
      uppercase letters, hyphens (-), and forward slash (/). It cannot start or end
      with forward slash (/) because they are automatically appended.
    Default: qa
    Description: S3 key prefix for the Quick Start assets. Quick Start key prefix
      can include numbers, lowercase letters, uppercase letters, hyphens (-), and
      forward slash (/). It cannot start or end with forward slash (/) because they
      are automatically appended.
    Type: String
  pKeyPair:
    AllowedPattern: ^[0-9a-zA-Z-]+(/[0-9a-zA-Z-]+)*$
    ConstraintDescription: Quick Start key prefix can include numbers, lowercase letters,
      uppercase letters, hyphens (-), and forward slash (/). It cannot start or end
      with forward slash (/) because they are automatically appended.
    Default: SSLTEST
    Type: String
Mappings:
  mGeoLocation:
      North-America:
          Id: 'NA'
      Europe:
          Id: 'EU'
  AWSInfoRegionMap:
    ap-northeast-1:
      Partition: aws
      QuickStartS3URL: https://s3.amazonaws.com
    ap-northeast-2:
      Partition: aws
      QuickStartS3URL: https://s3.amazonaws.com
    ap-south-1:
      Partition: aws
      QuickStartS3URL: https://s3.amazonaws.com
    ap-southeast-1:
      Partition: aws
      QuickStartS3URL: https://s3.amazonaws.com
    ap-southeast-2:
      Partition: aws
      QuickStartS3URL: https://s3.amazonaws.com
    ca-central-1:
      Partition: aws
      QuickStartS3URL: https://s3.amazonaws.com
    eu-central-1:
      Partition: aws
      QuickStartS3URL: https://s3.amazonaws.com
    eu-west-1:
      Partition: aws
      QuickStartS3URL: https://s3.amazonaws.com
    eu-west-2:
      Partition: aws
      QuickStartS3URL: https://s3.amazonaws.com
    sa-east-1:
      Partition: aws
      QuickStartS3URL: https://s3.amazonaws.com
    us-east-1:
      Partition: aws
      QuickStartS3URL: https://s3.amazonaws.com
    us-east-2:
      Partition: aws
      QuickStartS3URL: https://s3.amazonaws.com
    us-gov-west-1:
      Partition: aws-us-gov
      QuickStartS3URL: https://s3-us-gov-west-1.amazonaws.com
    us-west-1:
      Partition: aws
      QuickStartS3URL: https://s3.amazonaws.com
    us-west-2:
      Partition: aws
      QuickStartS3URL: https://s3.amazonaws.com

Resources:
  rProductionVpcTemplate:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL:
        !Sub
        - ${QuickStartS3URL}/${QSS3BucketName}/${QSS3KeyPrefix}/vpc.yml
        - QuickStartS3URL:
            !FindInMap
            - AWSInfoRegionMap
            - !Ref AWS::Region
            - QuickStartS3URL
      TimeoutInMinutes: 20
      Parameters:
        EnvironmentName:           !Ref AWS::StackName
        VpcCIDR:                   !Ref pVpCIDR
        PublicSubnet1CIDR:         !Ref pPublicSubnet1CIDR
        PublicSubnet2CIDR:         !Ref pPublicSubnet2CIDR
        PrivateSubnet1CIDR:        !Ref pPrivateSubnet1CIDR
        PrivateSubnet2CIDR:        !Ref pPrivateSubnet2CIDR
